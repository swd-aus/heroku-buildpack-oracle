#!/usr/bin/env bash

set -e

BUILD_DIR=$1
ENV_DIR=$2

ORACLE_HOME="${BUILD_DIR}/oracle"
ORACLE_INSTANT_CLIENT_URL="https://download.oracle.com/otn_software/linux/instantclient/185000/instantclient-basiclite-linux.x64-18.5.0.0.0dbru.zip"
ORACLE_SQLPLUS="https://download.oracle.com/otn_software/linux/instantclient/185000/instantclient-sqlplus-linux.x64-18.5.0.0.0dbru.zip"
ORACLE_SDK="https://download.oracle.com/otn_software/linux/instantclient/185000/instantclient-sdk-linux.x64-18.5.0.0.0dbru.zip"

mkdir -p ${ORACLE_HOME}
curl -s -S -L ${ORACLE_INSTANT_CLIENT_URL} > ${ORACLE_HOME}/oracle_instant_client.zip \
  && unzip ${ORACLE_HOME}/oracle_instant_client.zip -d ${ORACLE_HOME} \
  && rm ${ORACLE_HOME}/oracle_instant_client.zip

curl -s -S -L ${ORACLE_SQLPLUS} > ${ORACLE_HOME}/oracle_sqlplus.zip \
  && unzip ${ORACLE_HOME}/oracle_sqlplus.zip -d ${ORACLE_HOME} \
  && rm ${ORACLE_HOME}/oracle_sqlplus.zip

curl -s -S -L ${ORACLE_SDK} > ${ORACLE_HOME}/oracle_sdk.zip \
  && unzip ${ORACLE_HOME}/oracle_sdk.zip -d ${ORACLE_HOME} \
  && rm ${ORACLE_HOME}/oracle_sdk.zip

ORACLE_INSTANT_CLIENT_DIR="${ORACLE_HOME}/instantclient_18_5"

mkdir -p ${BUILD_DIR}/.profile.d

cat <<EOF > ${BUILD_DIR}/.profile.d/oracle.sh
  export ORACLE_HOME=app/oracle
  export PATH=app/oracle/bin:\$PATH
  export ORACLE_SID=xe
  export ORACLE_SYSTEM_PASSWORD=qwerty123
  export LD_LIBRARY_PATH=app/oracle/instantclient_18_5:/app/.apt/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH
  export DYLD_LIBRARY_PATH=app/oracle/instantclient_18_5:\$DYLD_LIBRARY_PATH
  export OCI_LIB_DIR=app/oracle/instantclient_18_5
  export OCI_INC_DIR=app/oracle/instantclient_18_5/sdk/include
  export TNS_ADMIN=app/oracle/instantclient_18_5/network/admin
EOF

source ${BUILD_DIR}/.profile.d/oracle.sh

LD_LIBRARY_PATH_FILE="$ENV_DIR/LD_LIBRARY_PATH"
echo $ORACLE_HOME >> $LD_LIBRARY_PATH_FILE
